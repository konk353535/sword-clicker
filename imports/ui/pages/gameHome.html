<template name="gameHomePage">
  <div class="container mt-3">
    <div class="d-flex flex-wrap">
      <div class="mr-3 hidden-md-down" style="min-width: 150px">
        <div class="text-muted mb-1">Links</div>
        <a href="/shop" class="side-link-item">Shop</a>
        <a href="/skills" class="side-link-item">Skills</a>
        <a href="/clan" class="side-link-item">Clan</a>
        <a href="/achievements" class="side-link-item">Achievements</a>
        <a href="/patchNotes" class="side-link-item">FAQ</a>
        <a href="/updates" class="side-link-item new-update-color">New Things</a>
      </div>
      <div class="home-page-content game-home-page-container">

        {{#if inCurrentBattle}}
          <div class="d-flex align-items-center text-danger mb-3">
            You are currently in a battle
            <div class="d-flex flex-grow justify-content-end">
              <a href="/newCombat" class="btn btn-secondary">View</a>
            </div>
          </div>
        {{/if}}

        {{#if firstClanInvite}}
          <div class="d-flex align-items-center mb-3">
            Clan invite to {{firstClanInvite.clanName}} from {{firstClanInvite.inviterName}}
            <div class="d-flex flex-grow justify-content-end">
              <button class="btn btn-primary mr-2 accept-clan-invite" data-id={{firstClanInvite._id}}>Accept</button>
              <button class="btn btn-danger decline-clan-invite" data-id={{firstClanInvite._id}}>Decline</button>
            </div>
          </div>
        {{/if}}

        {{#if firstRecievedFriendRequest}}
          <div class="d-flex align-items-center mb-3">
            Friend request from {{firstRecievedFriendRequest.senderName}}
            <div class="d-flex flex-grow justify-content-end">
              <button class="btn btn-primary mr-2 accept-friend-invite" data-sender={{firstRecievedFriendRequest.sender}}>Accept</button>
              <button class="btn btn-danger decline-friend-invite" data-sender={{firstRecievedFriendRequest.sender}}>Decline</button>
            </div>
          </div>
        {{/if}}

        {{#if firstPendingInvite}}
          <div class="d-flex align-items-center mb-3">
            Party invite from {{firstPendingInvite.leaderName}}
            <div class="d-flex flex-grow justify-content-end">
              <button class="btn btn-primary mr-2 accept-party-invite" data-id={{firstPendingInvite._id}}>Accept</button>
              <button class="btn btn-danger decline-party-invite" data-id={{firstPendingInvite._id}}>Decline</button>
            </div>
          </div>
        {{/if}}

        <!-- Mining -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/mining" class="text-muted">Mining Carts</a>
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{> miningCollector}}
          </div>
        </div>

        <!-- Crafting -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/crafting" class="text-muted">Workbench</a>
            {{#if firstCrafting}}
              <div class="d-flex flex-grow justify-content-end">
                <div class="text-muted ml-3">
                  {{> readableDuration endDate=lastCrafting.endDate}}
                </div>
              </div>
            {{/if}}
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{#if firstCrafting}}
              {{> firstCraftingUI data=firstCrafting}}
            {{else}}
              <div class="text-muted">Empty</div>
            {{/if}}
            <div class="d-flex flex-wrap">
              {{#each otherCrafting}}
                <div class="d-flex icon-box-new mr-1 mt-1">
                  <div class="align-items-center d-flex" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
                    <img src="/icons/{{this.icon}}" class="extra-small-icon mr-1">
                    <div>{{this.amount}}</div>
                    <i class="fas fa-times icon-danger-hover cancel-crafting cursor-pointer ml-2" data-enddate="{{this.endDate}}"></i>
                  </div>
                </div>
              {{/each}}
            </div>
          </div>
        </div>

        <!-- Lumber -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/woodcutting" class="text-muted">Lumber Carriages</a>
          </div>
          <div class="d-flex flex-wrap mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{> woodcuttingCollector}}
          </div>
        </div>

        <!-- Farming -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/farming" class="text-muted">Farm Plots</a>
            <div class="d-flex flex-grow justify-content-end">
              {{#if lastGrownThing}}
                <div class="text-muted ml-3">
                  {{> readableDuration endDate=lastGrownThing.maturityDate}}
                </div>
              {{/if}}
            </div>
          </div>
          <div class="d-flex flex-wrap mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{#each farmingSpaces}}
              {{> farmSpace farmSpace=this classes="medium-icon"}}
            {{/each}}
            {{#if showPickAll}}
              <div class="d-flex align-items-center mt-1 ml-1">
                <button class="btn btn-primary collect-plants">
                  Pick All
                </button>
              </div>
            {{/if}}
          </div>
        </div>
        <!-- Adventures -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/newCombat" class="text-muted">Adventures</a>
            <div class="d-flex justify-content-end flex-grow">
              <div class="text-muted ml-3">
                {{> readableDuration endDate=lastAdventure.endDate}}
              </div>
            </div>
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{> adventuresList adventures=activeAdventures}}
          </div>
        </div>
      </div>
      <div class="live-feed-content d-flex flex-column flex-grow">
        <!-- Friends Card -->
        <div>
          <div class="d-flex text-muted mb-1 align-items-center">
            Friends
            <div class="d-flex flex-grow justify-content-end">
              <a href="#" class="add-friends">
                Add
              </a>
            </div>
          </div>
          {{#if showAddFriends}}
            <form class="friend-invite d-flex flex-grow align-items-center mb-1">
              <div class="flex-grow">
                <label class="sr-only" for="name">Name</label>
                <input class="form-control typeahead" name="team" id="add-friend-input" type="text"
                  placeholder="Name"
                  autocomplete="off" spellcheck="off"
                  data-source="search" />
              </div>
              <button type="submit" class="btn btn-primary btn-invite ml-1">Invite</button>
            </form>
            <hr style="width: 100%" class="my-2" />
          {{/if}}
          {{#each friendsList}}
            {{> friendRow friend=this}}
          {{else}}
            You have no friends
          {{/each}}
          {{#if sentFriendRequests.length}}
            <hr style="width: 100%" class="mb-1">
            {{#each sentFriendRequests}}
              <div class="d-flex align-items-center flex-grow mt-1">
                <div class="badge badge-grey-1 mr-3" style="width: 70px">Pending</div>
                <div class="flex-grow text-capitalize">{{this.recieverName}}</div>
                <button class="btn btn-danger btn-sm cancel-friend-request" data-reciever="{{this.reciever}}">Cancel</button>
              </div>
            {{/each}}
          {{/if}}
        </div>
        <div class="mt-2">
          <div class="d-flex text-muted mb-1 align-items-center">
            {{#if myClan}}
              <a href="/clan">Clan</a>
            {{else}}
              Clan
              <div class="d-flex flex-grow justify-content-end">
                <a href="/clan" class="create-clan">
                  Create
                </a>
              </div>
            {{/if}}
          </div>

          {{#if myClan}}
            {{myClan.name}}
          {{else}}
            Your not in a clan
          {{/if}}
        </div>
        <div class="mt-2">
          <div class="text-muted mb-1">
            Recent Battlers
          </div>
          Todo...
          <!-- Groups of friends / Clans mates here to easily join -->
        </div>
      </div>
      <div class="mr-3 hidden-md-up" style="min-width: 150px">
        <div class="text-muted mb-1">Links</div>
        <a href="/shop" class="side-link-item">Shop</a>
        <a href="/skills" class="side-link-item">Skills</a>
        <a href="/clan" class="side-link-item">Clan</a>
        <a href="/achievements" class="side-link-item">Achievements</a>
        <a href="/patchNotes" class="side-link-item">FAQ</a>
        <a href="/updates" class="side-link-item new-update-color">New Things</a>
      </div>
    </div>
  </div>
</template>

<template name="firstCraftingUI">
  <div class="d-flex child-show-hover icon-box-new flex-grow align-items-center mt-1" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
    <img src="/icons/{{data.icon}}" class="extra-small-icon mr-1">
    <div class="mr-3">{{data.amount}}</div>
    <div class="progress mr-3 flex-grow">
      <div
        class="progress-bar bg-primary"
        role="progressbar"
        style="width: {{computedCraftingProcess.percentage}}%;" 
        aria-valuenow="50"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        {{> formatNumber number=computedCraftingProcess.percentage}}%
      </div>
    </div>
    <div class="text-muted">{{> readableDuration endDate=computedCraftingProcess.endDate}}</div>
    <i class="fas fa-times icon-danger-hover cursor-pointer cancel-crafting ml-2" data-enddate="{{computedCraftingProcess.endDate}}"></i>
  </div>
</template>

<template name="friendRow">
  <div class="d-flex align-items-center flex-grow mb-1">
    <div class="badge text-capitalize
      {{#if computedFriend.afk}}badge-grey-0{{else}}badge-success{{/if}} mr-1
    " style="width: 80px">
      {{#if computedFriend.afk}}
        {{> readableDuration startDate=computedFriend.lastActionDate}}
      {{else}}
        {{friend.lastAction}}
      {{/if}}
    </div>
    <div class="flex-grow text-capitalize"
      style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;"
    >
      <a href="/profile/{{friend.username}}" class="text-muted">
        {{friend.username}}
      </a>
    </div>
    <div class="d-flex justify-content-end flex-grow">
      {{#if $and myGroup ($eq myGroup._id friend.partyId)}}
        <div class="badge badge-primary">In Group</div>
      {{else}}
        {{#if friend.partyId}}
          <button class="btn btn-primary btn-sm mr-1 join-group">Join</button>
        {{/if}}
        {{#if computedFriend.hasInvitedToMyGroup}}
          <div class="badge badge-info">Invited</div>
        {{else if canInvite}}
          <button class="btn btn-secondary btn-sm invite-to-group">Invite</button>
        {{/if}}
      {{/if}}
    </div>
  </div>
</template>

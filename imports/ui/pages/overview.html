<template name="overviewPage">
  <div class="container-lg mt-3">
    <div class="d-flex flex-wrap">
      <div class="mr-3 hidden-md-down" style="min-width: 150px">
        {{#if currentUser}}
          <a href="/profile/{{currentUser.username}}" class="side-link-item">Profile</a>
        {{/if}}
        <a href="/shop" class="side-link-item">Shop</a>
        <a href="/achievements" class="side-link-item">Achievements</a>
        <a href="/updates" class="side-link-item new-update-color">Updates</a>
        <a href="/faq" class="side-link-item">F.A.Q.</a>
      </div>

      <div class="home-page-content game-home-page-container">

        {{#if inCurrentBattle}}
          <div class="d-flex align-items-center text-danger mb-3">
            You are currently in a battle
            <div class="d-flex flex-grow justify-content-end">
              <a href="/battle" class="btn btn-secondary">View</a>
            </div>
          </div>
        {{/if}}

        {{#if firstRecievedFriendRequest}}
          <div class="d-flex align-items-center mb-3">
            Friend request from {{firstRecievedFriendRequest.senderName}}
            <div class="d-flex flex-grow justify-content-end">
              <button class="btn btn-primary mr-2 accept-friend-invite" data-sender={{firstRecievedFriendRequest.sender}}>Accept</button>
              <button class="btn btn-danger decline-friend-invite" data-sender={{firstRecievedFriendRequest.sender}}>Decline</button>
            </div>
          </div>
        {{/if}}

        {{#if firstPendingInvite}}
          <div class="d-flex align-items-center mb-3">
            Party invite from {{firstPendingInvite.leaderName}}
            <div class="d-flex flex-grow justify-content-end">
              <button class="btn btn-primary mr-2 accept-party-invite" data-id={{firstPendingInvite._id}}>Accept</button>
              <button class="btn btn-danger decline-party-invite" data-id={{firstPendingInvite._id}}>Decline</button>
            </div>
          </div>
        {{/if}}

        {{#if $gte currentGroupMembers.length 2}}
          <div class="mb-3 d-flex flex-column">
            <div class="d-flex align-items-center">
              <a class="text-muted" href="/battle">Your Party</a>
            </div>
            <div class="d-flex justify-content-center flex-wrap mt-2 pt-1" style="border-top: 1px solid #DFDFDF; margin-bottom: 20px">
              {{#each currentGroupMembers}}
                <div class="flex-column d-flex justify-content-center" style="margin-top: 20px">
                  {{> lobbyUnit unit=this}}
                </div>
              {{/each}}
            </div>
          </div>
        {{/if}}
        
        <!-- Adventures -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/battle" class="text-muted adventures-nav-link">Adventures</a>
            <div class="d-flex justify-content-end flex-grow">
              <div class="text-muted ml-3">
                {{> readableDuration endDate=lastAdventure.endDate}}
              </div>
            </div>
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{> adventuresList adventures=activeAdventures}}
          </div>
        </div>
      
        <!-- Mining -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/mining" class="text-muted">Mining Summary</a>
          </div>
          <div class="d-flex flex-column mb-3" style="border-top: 1px solid #DFDFDF;">
            <div class="d-flex flex-row flex-wrap mine-pit-container" style="max-width: 160px; margin-top: 4px;">
              {{#each miningSpaces}}
                {{> mineSpace mineSpace=this tiny=true}}
              {{/each}}
            </div>
          </div>
        </div>
        
        <!-- Crafting -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/crafting" class="text-muted">Crafting Workbench</a>
            {{#if firstCrafting}}
              <div class="d-flex flex-grow justify-content-end">
                <div class="text-muted ml-3">
                  {{> readableDuration endDate=lastCrafting.endDate}}
                </div>
              </div>
            {{/if}}
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{#if firstCrafting}}
              {{> firstCraftingUI data=firstCrafting}}
            {{else}}
              <div class="text-muted">Empty</div>
            {{/if}}
            <div class="d-flex flex-wrap">
              {{#each otherCrafting}}
                <div class="d-flex icon-box-new mr-1 mt-1">
                  <div class="align-items-center d-flex" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
                    <img src="/icons/{{this.icon}}" class="extra-small-icon mr-1">
                    <div>{{this.amount}}</div>
                    <i class="fas fa-times icon-danger-hover cancel-crafting cursor-pointer ml-2" data-enddate="{{this.endDate}}"></i>
                  </div>
                </div>
              {{/each}}
            </div>
          </div>
        </div>
        
        <!-- Reforging -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/crafting" class="text-muted">Reforging</a>
            {{#if firstReforging}}
              <div class="d-flex flex-grow justify-content-end">
                <div class="text-muted ml-3">
                  {{> readableDuration endDate=lastReforging.endDate}}
                </div>
              </div>
            {{/if}}
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{#if firstReforging}}
              {{> firstCraftingUI data=firstReforging}}
            {{else}}
              <div class="text-muted">Empty</div>
            {{/if}}
            <div class="d-flex flex-wrap">
              {{#each otherReforging}}
                <div class="d-flex icon-box-new mr-1 mt-1">
                  <div class="align-items-center d-flex" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
                    <img src="/icons/{{icon(this.itemId)}}" class="extra-small-icon mr-1">
                    <i class="fas fa-times icon-danger-hover cancel-reforging cursor-pointer ml-2" data-enddate="{{this.endDate}}"></i>
                  </div>
                </div>
              {{/each}}
          </div>
          </div>
        </div>

        <!-- Inscription -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/inscription" class="text-muted">Inscription Workbench</a>
            {{#if firstInscription}}
              <div class="d-flex flex-grow justify-content-end">
                <div class="text-muted ml-3">
                  {{> readableDuration endDate=lastInscription.endDate}}
                </div>
              </div>
            {{/if}}
          </div>
          <div class="d-flex flex-column mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{#if firstInscription}}
              {{> firstInscriptionUI data=firstInscription}}
            {{else}}
              <div class="text-muted">Empty</div>
            {{/if}}
            <div class="d-flex flex-wrap">
              {{#each otherInscription}}
                <div class="d-flex icon-box-new mr-1 mt-1">
                  <div class="align-items-center d-flex" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
                    <img src="/icons/{{this.icon}}" class="extra-small-icon mr-1">
                    <div>{{this.amount}}</div>
                    <i class="fas fa-times icon-danger-hover cancel-inscription cursor-pointer ml-2" data-enddate="{{this.endDate}}"></i>
                  </div>
                </div>
              {{/each}}
            </div>
          </div>
        </div>

        <!-- Farming -->
        <div class="d-flex flex-column mb-3">
          <div class="d-flex align-items-center">
            <a href="/farming" class="text-muted">Farm Plots</a>
            <div class="d-flex flex-grow justify-content-end">
              {{#if lastGrownThing}}
                <div class="text-muted ml-3">
                  {{> readableDuration endDate=lastGrownThing.maturityDate}}
                </div>
              {{/if}}
            </div>
          </div>
          <div class="d-flex flex-wrap mt-2 pt-1" style="border-top: 1px solid #DFDFDF">
            {{#each farmingSpaces}}
              {{> farmSpace farmSpace=this classes="medium-icon" styles="height: 66px;"}}
            {{/each}}
            {{#if showPickAll}}
              <div class="d-flex align-items-center mt-1 ml-1">
                <button class="btn btn-primary collect-plants">
                  Pick All
                </button>
              </div>
            {{/if}}
          </div>
        </div>
        
      </div>

      <div class="live-feed-content d-flex flex-column">
        <!-- Friends Card -->
        <div>
          <div class="d-flex text-muted mb-1 align-items-center">
            Friends
            <div class="d-flex flex-grow justify-content-end">
              <a href="#" class="add-friends">
                Add
              </a>
            </div>
          </div>
          {{#if showAddFriends}}
            <form class="friend-add d-flex flex-grow align-items-center mb-1">
              <div class="flex-grow">
                <label class="sr-only" for="name">Name</label>
                <input class="form-control typeahead" name="team" id="add-friend-input" type="text"
                  placeholder="Name"
                  autocomplete="off" spellcheck="off"
                  data-source="search" />
              </div>
              <button type="submit" class="btn btn-primary btn-invite ml-1">Add</button>
            </form>
            <hr style="width: 100%" class="my-2" />
          {{/if}}
          {{#each friendsList}}
            {{> friendRow friend=this}}
          {{else}}
            You have no friends
          {{/each}}
        </div>
      </div>

      <!-- this version for mobile -->
      <div class="mr-3 hidden-lg-up" style="min-width: 150px">
        {{#if currentUser}}
          <a href="/profile/{{currentUser.username}}" class="side-link-item">Profile</a>
        {{/if}}
        <a href="/shop" class="side-link-item">Shop</a>
        <a href="/achievements" class="side-link-item">Achievements</a>
        <a href="/updates" class="side-link-item new-update-color">Updates</a>
        <a href="/faq" class="side-link-item">F.A.Q.</a>
      </div>      
    </div>
  </div>
</template>

<template name="firstCraftingUI">
  <div class="d-flex child-show-hover icon-box-new flex-grow align-items-center mt-1" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
    <img src="/icons/{{icon}}" class="extra-small-icon mr-1">
    <div class="mr-3">{{data.amount}}</div>
    <div class="progress mr-3 flex-grow">
      <div
        class="progress-bar bg-primary"
        role="progressbar"
        style="width: {{computedCraftingProcess.percentage}}%;" 
        aria-valuenow="50"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        {{> formatNumber number=computedCraftingProcess.percentage}}%
      </div>
    </div>
    <div class="text-muted">{{> readableDuration endDate=computedCraftingProcess.endDate}}</div>
    <i class="fas fa-times icon-danger-hover cursor-pointer cancel-crafting ml-2" data-enddate="{{computedCraftingProcess.endDate}}"></i>
  </div>
</template>

<template name="firstInscriptionUI">
  <div class="d-flex child-show-hover icon-box-new flex-grow align-items-center mt-1" style="border: 1px solid #DFDFDF; border-radius: 4px; padding: 8px;">
    <img src="/icons/{{data.icon}}" class="extra-small-icon mr-1">
    <div class="mr-3">{{data.amount}}</div>
    <div class="progress mr-3 flex-grow">
      <div
        class="progress-bar bg-primary"
        role="progressbar"
        style="width: {{computedInscriptionProcess.percentage}}%;" 
        aria-valuenow="50"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        {{> formatNumber number=computedInscriptionProcess.percentage}}%
      </div>
    </div>
    <div class="text-muted">{{> readableDuration endDate=computedInscriptionProcess.endDate}}</div>
    <i class="fas fa-times icon-danger-hover cursor-pointer cancel-inscription ml-2" data-enddate="{{computedInscriptionProcess.endDate}}"></i>
  </div>
</template>

<template name="friendRow">
  <div class="d-flex align-items-center flex-grow mb-1">
    <div class="badge text-capitalize
      {{#if computedFriend.offline}}badge-grey-0{{else if computedFriend.afk}}badge-orange-4{{else}}badge-green-1{{/if}} mr-1
    " style="width: 80px">
      {{#if computedFriend.offline}}
        {{> readableDuration startDate=computedFriend.lastActionDate}}
      {{else if computedFriend.afk}}
        {{> readableDuration startDate=computedFriend.lastActionDate}}
      {{else}}
        online
      {{/if}}
    </div>
    <div class="flex-grow"
      style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;"
    >
      <a href="/profile/{{friend.username}}" class="text-muted">
        {{friend.username}}
      </a>
    </div>
    <div class="d-flex justify-content-end flex-grow">
      <button class="btn btn-warning btn-sm mr-1 remove-friend">Remove</button>
    </div>
    <div class="d-flex justify-content-end">
      {{#if $and myGroup ($eq myGroup._id friend.partyId)}}
        <div class="badge badge-primary">In Group</div>
      {{else}}
        {{#if friend.partyId}}
          <button class="btn btn-primary btn-sm mr-1 join-group">Join</button>
        {{/if}}
        {{#if computedFriend.hasInvitedToMyGroup}}
          <button class="btn btn-secondary btn-sm mr-1 badge-info" style="color: white;">Invited</button>
        {{else if canInvite}}
          <button class="btn btn-secondary btn-sm invite-to-group">Invite</button>
        {{/if}}
      {{/if}}
    </div>
  </div>
</template>
